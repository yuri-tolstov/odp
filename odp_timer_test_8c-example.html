<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>API Reference Manual: odp_timer_test.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="odpdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ODP-Logo-HQ.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">API Reference Manual
   &#160;<span id="projectnumber">1.24.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('odp_timer_test_8c-example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">odp_timer_test.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Timer example application</p>
<div class="fragment"><div class="line"><span class="comment">/* Copyright (c) 2013-2018, Linaro Limited</span></div><div class="line"><span class="comment"> * All rights reserved.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * SPDX-License-Identifier:     BSD-3-Clause</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/* ODP main header */</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="odp__api_8h.html">odp_api.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/* ODP helper for Linux apps */</span></div><div class="line"><span class="preprocessor">#include &lt;odp/helper/odph_api.h&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/* GNU lib C */</span></div><div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/* Max worker threads */</span></div><div class="line"><span class="preprocessor">#define MAX_WORKERS           (ODP_THREAD_COUNT_MAX - 1)</span></div><div class="line"><span class="preprocessor">#define NUM_TMOS              10000         </span></div><div class="line"><span class="preprocessor">#define WAIT_NUM          10    </span></div><div class="line"><span class="preprocessor">#define MAX(a, b) (((a) &gt; (b)) ? (a) : (b))</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cpu_count; </div><div class="line">    <span class="keywordtype">int</span> resolution_us; </div><div class="line">    <span class="keywordtype">int</span> min_us;        </div><div class="line">    <span class="keywordtype">int</span> max_us;        </div><div class="line">    <span class="keywordtype">int</span> period_us;     </div><div class="line">    <span class="keywordtype">int</span> tmo_count;     </div><div class="line">} test_args_t;</div><div class="line"></div><div class="line"><span class="keyword">struct </span>test_timer {</div><div class="line">    <a name="_a0"></a><a class="code" href="struct__odp__abi__timer__t.html">odp_timer_t</a> tim;</div><div class="line">    <a name="_a1"></a><a class="code" href="struct__odp__abi__event__t.html">odp_event_t</a> ev;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    test_args_t args;       </div><div class="line">    <a name="_a2"></a><a class="code" href="structodp__barrier__s.html">odp_barrier_t</a> test_barrier; </div><div class="line">    <a name="_a3"></a><a class="code" href="struct__odp__abi__pool__t.html">odp_pool_t</a> pool;        </div><div class="line">    <a name="_a4"></a><a class="code" href="struct__odp__abi__timer__pool__t.html">odp_timer_pool_t</a> tp;        </div><div class="line">    <a name="_a5"></a><a class="code" href="structodp__atomic__u32__s.html">odp_atomic_u32_t</a> remain;    </div><div class="line">    <span class="keyword">struct </span>test_timer tt[256];  </div><div class="line">    uint32_t num_workers;       </div><div class="line">} test_globals_t;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *timerset2str(<a class="code" href="group__odp__timer.html#gabc44cd432f4af853655b9ad292abd8b2">odp_timer_set_t</a> val)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (val) {</div><div class="line">    <span class="keywordflow">case</span> <a name="a6"></a><a class="code" href="group__odp__timer.html#ggabc44cd432f4af853655b9ad292abd8b2a6cf6bb923bdf13cede58a481443be93c">ODP_TIMER_SUCCESS</a>:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;success&quot;</span>;</div><div class="line">    <span class="keywordflow">case</span> <a name="a7"></a><a class="code" href="group__odp__timer.html#ggabc44cd432f4af853655b9ad292abd8b2a65fde153ce6d19c9af7907e7b09dd916">ODP_TIMER_TOOEARLY</a>:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;too early&quot;</span>;</div><div class="line">    <span class="keywordflow">case</span> <a name="a8"></a><a class="code" href="group__odp__timer.html#ggabc44cd432f4af853655b9ad292abd8b2aa4578ce04a1baa4895970be2d4482856">ODP_TIMER_TOOLATE</a>:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;too late&quot;</span>;</div><div class="line">    <span class="keywordflow">case</span> <a name="a9"></a><a class="code" href="group__odp__timer.html#ggabc44cd432f4af853655b9ad292abd8b2ae919a9963367e42e244e21a90671bc33">ODP_TIMER_NOEVENT</a>:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;no event&quot;</span>;</div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;?&quot;</span>;</div><div class="line">    }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> remove_prescheduled_events(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="struct__odp__abi__event__t.html">odp_event_t</a> ev;</div><div class="line">    <a name="_a10"></a><a class="code" href="struct__odp__abi__queue__t.html">odp_queue_t</a> queue;</div><div class="line">    <a name="a11"></a><a class="code" href="group__odp__scheduler.html#ga9868ccb25b6631ef29cc921ee2e522b0">odp_schedule_pause</a>();</div><div class="line">    <span class="keywordflow">while</span> ((ev = <a name="a12"></a><a class="code" href="group__odp__scheduler.html#gae4ca1012ebb16ff8b9752b958dc45ce6">odp_schedule</a>(&amp;queue, <a name="a13"></a><a class="code" href="group__odp__scheduler.html#ga9116776b8262a74af7dac7ef46fc7ace">ODP_SCHED_NO_WAIT</a>)) !=</div><div class="line">            <a name="a14"></a><a class="code" href="group__odp__event.html#gae1a3732a534ba7a892fca38b824591b0">ODP_EVENT_INVALID</a>) {</div><div class="line">        <a name="a15"></a><a class="code" href="group__odp__event.html#ga1622f73356c325f625db747cb3badf8d">odp_event_free</a>(ev);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> test_abs_timeouts(<span class="keywordtype">int</span> thr, test_globals_t *gbls)</div><div class="line">{</div><div class="line">    uint64_t period;</div><div class="line">    uint64_t period_ns;</div><div class="line">    <a class="code" href="struct__odp__abi__queue__t.html">odp_queue_t</a> queue;</div><div class="line">    uint64_t tick;</div><div class="line">    <span class="keyword">struct </span>test_timer *ttp;</div><div class="line">    <a name="_a16"></a><a class="code" href="struct__odp__abi__timeout__t.html">odp_timeout_t</a> tmo;</div><div class="line">    uint32_t num_workers = gbls-&gt;num_workers;</div><div class="line"></div><div class="line">    ODPH_DBG(<span class="stringliteral">&quot;  [%i] test_timeouts\n&quot;</span>, thr);</div><div class="line"></div><div class="line">    queue = <a name="a17"></a><a class="code" href="group__odp__queue.html#ga22cd9716719cd2b35c88267eb1f16d49">odp_queue_lookup</a>(<span class="stringliteral">&quot;timer_queue&quot;</span>);</div><div class="line"></div><div class="line">    period_ns = gbls-&gt;args.period_us * <a name="a18"></a><a class="code" href="group__odp__time.html#gacc306c00304a0d479e89c2cd16d39938">ODP_TIME_USEC_IN_NS</a>;</div><div class="line">    period    = <a name="a19"></a><a class="code" href="group__odp__timer.html#ga7fb23a28aa1db3c919aa49c90b2316fb">odp_timer_ns_to_tick</a>(gbls-&gt;tp, period_ns);</div><div class="line"></div><div class="line">    ODPH_DBG(<span class="stringliteral">&quot;  [%i] period %&quot;</span> PRIu64 <span class="stringliteral">&quot; ticks,  %&quot;</span> PRIu64 <span class="stringliteral">&quot; ns\n&quot;</span>, thr,</div><div class="line">         period, period_ns);</div><div class="line"></div><div class="line">    ODPH_DBG(<span class="stringliteral">&quot;  [%i] current tick %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>, thr,</div><div class="line">         <a name="a20"></a><a class="code" href="group__odp__timer.html#ga680573fd461db24d4e66540b37deea43">odp_timer_current_tick</a>(gbls-&gt;tp));</div><div class="line"></div><div class="line">    ttp = &amp;gbls-&gt;tt[thr];</div><div class="line">    ttp-&gt;tim = <a name="a21"></a><a class="code" href="group__odp__timer.html#ga3062fb9e49eefe349f3c6bd6518b91e6">odp_timer_alloc</a>(gbls-&gt;tp, queue, ttp);</div><div class="line">    <span class="keywordflow">if</span> (ttp-&gt;tim == <a name="a22"></a><a class="code" href="group__odp__timer.html#gaea51c621bb26b7a8bdab46d8a08f247a">ODP_TIMER_INVALID</a>) {</div><div class="line">        ODPH_ERR(<span class="stringliteral">&quot;Failed to allocate timer\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line">    tmo = <a name="a23"></a><a class="code" href="group__odp__timer.html#ga1d1006d0da428f8afd5527b673f777a9">odp_timeout_alloc</a>(gbls-&gt;pool);</div><div class="line">    <span class="keywordflow">if</span> (tmo == <a name="a24"></a><a class="code" href="group__odp__timer.html#gac72c1c2f923ee0d53b0a7d4109da34a5">ODP_TIMEOUT_INVALID</a>) {</div><div class="line">        ODPH_ERR(<span class="stringliteral">&quot;Failed to allocate timeout\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line">    ttp-&gt;ev = <a name="a25"></a><a class="code" href="group__odp__timer.html#gac65e47ba9fdfd9ea73cb799e8e957d21">odp_timeout_to_event</a>(tmo);</div><div class="line">    tick = <a class="code" href="group__odp__timer.html#ga680573fd461db24d4e66540b37deea43">odp_timer_current_tick</a>(gbls-&gt;tp);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1) {</div><div class="line">        <span class="keywordtype">int</span> wait = 0;</div><div class="line">        <a class="code" href="struct__odp__abi__event__t.html">odp_event_t</a> ev;</div><div class="line">        <a class="code" href="group__odp__timer.html#gabc44cd432f4af853655b9ad292abd8b2">odp_timer_set_t</a> rc;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (ttp) {</div><div class="line">            tick += period;</div><div class="line">            rc = <a name="a26"></a><a class="code" href="group__odp__timer.html#gad2a16811f3aa03c58953f7c7b6ff1b62">odp_timer_set_abs</a>(ttp-&gt;tim, tick, &amp;ttp-&gt;ev);</div><div class="line">            <span class="keywordflow">if</span> (<a name="a27"></a><a class="code" href="group__odp__compiler__optim.html#ga2b29f27f12b751250b471aa9c14c57c8">odp_unlikely</a>(rc != <a class="code" href="group__odp__timer.html#ggabc44cd432f4af853655b9ad292abd8b2a6cf6bb923bdf13cede58a481443be93c">ODP_TIMER_SUCCESS</a>)) {</div><div class="line">                <span class="comment">/* Too early or too late timeout requested */</span></div><div class="line">                ODPH_ABORT(<span class="stringliteral">&quot;odp_timer_set_abs() failed: %s\n&quot;</span>,</div><div class="line">                       timerset2str(rc));</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Get the next expired timeout.</span></div><div class="line"><span class="comment">         * We invoke the scheduler in a loop with a timeout because</span></div><div class="line"><span class="comment">         * we are not guaranteed to receive any more timeouts. The</span></div><div class="line"><span class="comment">         * scheduler isn&#39;t guaranteeing fairness when scheduling</span></div><div class="line"><span class="comment">         * buffers to threads.</span></div><div class="line"><span class="comment">         * Use 1.5 second timeout for scheduler */</span></div><div class="line">        uint64_t sched_tmo =</div><div class="line">            <a name="a28"></a><a class="code" href="group__odp__scheduler.html#gab0a0d2673cc7371d5c5d782d13a485b8">odp_schedule_wait_time</a>(1500000000ULL);</div><div class="line">        <span class="keywordflow">do</span> {</div><div class="line">            ev = <a class="code" href="group__odp__scheduler.html#gae4ca1012ebb16ff8b9752b958dc45ce6">odp_schedule</a>(&amp;queue, sched_tmo);</div><div class="line">            <span class="comment">/* Check if odp_schedule() timed out, possibly there</span></div><div class="line"><span class="comment">             * are no remaining timeouts to receive */</span></div><div class="line">            <span class="keywordflow">if</span> (++wait &gt; WAIT_NUM &amp;&amp;</div><div class="line">                <a name="a29"></a><a class="code" href="group__odp__atomic.html#ga1ebc0fa6d690c24bd2bcc38bcb9a2276">odp_atomic_load_u32</a>(&amp;gbls-&gt;remain) &lt; num_workers)</div><div class="line">                ODPH_ABORT(<span class="stringliteral">&quot;At least one TMO was lost\n&quot;</span>);</div><div class="line">        } <span class="keywordflow">while</span> (ev == <a class="code" href="group__odp__event.html#gae1a3732a534ba7a892fca38b824591b0">ODP_EVENT_INVALID</a> &amp;&amp;</div><div class="line">             (<span class="keywordtype">int</span>)<a class="code" href="group__odp__atomic.html#ga1ebc0fa6d690c24bd2bcc38bcb9a2276">odp_atomic_load_u32</a>(&amp;gbls-&gt;remain) &gt; 0);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (ev == <a class="code" href="group__odp__event.html#gae1a3732a534ba7a892fca38b824591b0">ODP_EVENT_INVALID</a>)</div><div class="line">            <span class="keywordflow">break</span>; <span class="comment">/* No more timeouts */</span></div><div class="line">        <span class="keywordflow">if</span> (<a name="a30"></a><a class="code" href="group__odp__event.html#ga4bd59cdf228fe0c36b8e04fe122e047a">odp_event_type</a>(ev) != ODP_EVENT_TIMEOUT) {</div><div class="line">            <span class="comment">/* Not a default timeout event */</span></div><div class="line">            ODPH_ABORT(<span class="stringliteral">&quot;Unexpected event type (%u) received\n&quot;</span>,</div><div class="line">                   <a class="code" href="group__odp__event.html#ga4bd59cdf228fe0c36b8e04fe122e047a">odp_event_type</a>(ev));</div><div class="line">        }</div><div class="line">        <a class="code" href="struct__odp__abi__timeout__t.html">odp_timeout_t</a> tmo = <a name="a31"></a><a class="code" href="group__odp__timer.html#ga47e481181fbc79039f51f9c306257667">odp_timeout_from_event</a>(ev);</div><div class="line">        tick = <a name="a32"></a><a class="code" href="group__odp__timer.html#ga233f553eb0ba584d3be09431367fad27">odp_timeout_tick</a>(tmo);</div><div class="line">        ttp = <a name="a33"></a><a class="code" href="group__odp__timer.html#gaff83af8aaeca807c37862650a3493005">odp_timeout_user_ptr</a>(tmo);</div><div class="line">        ttp-&gt;ev = ev;</div><div class="line">        <span class="keywordflow">if</span> (!<a name="a34"></a><a class="code" href="group__odp__timer.html#gac14be427018b98cbbd1aa3e76fd57e62">odp_timeout_fresh</a>(tmo)) {</div><div class="line">            <span class="comment">/* Not the expected expiration tick, timer has</span></div><div class="line"><span class="comment">             * been reset or cancelled or freed */</span></div><div class="line">            ODPH_ABORT(<span class="stringliteral">&quot;Unexpected timeout received (timer &quot;</span></div><div class="line">                   <span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;, tick %&quot;</span> PRIu64 <span class="stringliteral">&quot;)\n&quot;</span>,</div><div class="line">                   <a name="a35"></a><a class="code" href="group__odp__timer.html#gaebafe4258e44d3b7ba5d110669f0d65a">odp_timer_to_u64</a>(ttp-&gt;tim), tick);</div><div class="line">        }</div><div class="line">        ODPH_DBG(<span class="stringliteral">&quot;  [%i] timeout, tick %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>, thr, tick);</div><div class="line"></div><div class="line">        uint32_t rx_num = <a name="a36"></a><a class="code" href="group__odp__atomic.html#gac84cb77c8a0d6ab0a073d0b9ebc99e9f">odp_atomic_fetch_dec_u32</a>(&amp;gbls-&gt;remain);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (!rx_num)</div><div class="line">            ODPH_ABORT(<span class="stringliteral">&quot;Unexpected timeout received (timer &quot;</span></div><div class="line">                   <span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;, tick %&quot;</span> PRIu64 <span class="stringliteral">&quot;)\n&quot;</span>,</div><div class="line">                   <a class="code" href="group__odp__timer.html#gaebafe4258e44d3b7ba5d110669f0d65a">odp_timer_to_u64</a>(ttp-&gt;tim), tick);</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rx_num &gt; num_workers)</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line"></div><div class="line">        <a class="code" href="group__odp__event.html#ga1622f73356c325f625db747cb3badf8d">odp_event_free</a>(ttp-&gt;ev);</div><div class="line">        <a name="a37"></a><a class="code" href="group__odp__timer.html#ga553de2ffd40d08de7bb212d2fc5388e7">odp_timer_free</a>(ttp-&gt;tim);</div><div class="line">        ttp = NULL;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Remove any prescheduled events */</span></div><div class="line">    remove_prescheduled_events();</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> run_thread(<span class="keywordtype">void</span> *ptr)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> thr;</div><div class="line">    <a class="code" href="struct__odp__abi__pool__t.html">odp_pool_t</a> msg_pool;</div><div class="line">    test_globals_t *gbls;</div><div class="line"></div><div class="line">    gbls = ptr;</div><div class="line">    thr  = <a name="a38"></a><a class="code" href="group__odp__thread.html#gad6562e7320d48463715bbf15748ae360">odp_thread_id</a>();</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;Thread %i starts on cpu %i\n&quot;</span>, thr, <a name="a39"></a><a class="code" href="group__odp__cpu.html#ga29ed8c7764aa102f385e150dab1d27f3">odp_cpu_id</a>());</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Find the pool</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    msg_pool = <a name="a40"></a><a class="code" href="group__odp__pool.html#ga80cbcff29933fbc847026c9c888aefe7">odp_pool_lookup</a>(<span class="stringliteral">&quot;msg_pool&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (msg_pool == <a name="a41"></a><a class="code" href="group__odp__pool.html#gafca03b58412260da754042a92f8a5e04">ODP_POOL_INVALID</a>) {</div><div class="line">        ODPH_ERR(<span class="stringliteral">&quot;  [%i] msg_pool not found\n&quot;</span>, thr);</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a name="a42"></a><a class="code" href="group__odp__barrier.html#ga97c8f84490e816330f96155acf0b4b77">odp_barrier_wait</a>(&amp;gbls-&gt;test_barrier);</div><div class="line"></div><div class="line">    test_abs_timeouts(thr, gbls);</div><div class="line"></div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;Thread %i exits\n&quot;</span>, thr);</div><div class="line">    fflush(NULL);</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> print_usage(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;\n\nUsage: ./odp_example [options]\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;Options:\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;  -c, --count &lt;number&gt;    CPU count, 0=all available, default=1\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;  -r, --resolution &lt;us&gt;   timeout resolution in usec\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;  -m, --min &lt;us&gt;          minimum timeout in usec\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;  -x, --max &lt;us&gt;          maximum timeout in usec\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;  -p, --period &lt;us&gt;       timeout period in usec\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;  -t, --timeouts &lt;count&gt;  timeout repeat count\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;  -h, --help              this help\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;\n\n&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> parse_args(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[], test_args_t *args)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> opt;</div><div class="line">    <span class="keywordtype">int</span> long_index;</div><div class="line">    <a name="_a43"></a><a class="code" href="structodp__timer__capability__t.html">odp_timer_capability_t</a> timer_capa;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>option longopts[] = {</div><div class="line">        {<span class="stringliteral">&quot;count&quot;</span>,      required_argument, NULL, <span class="charliteral">&#39;c&#39;</span>},</div><div class="line">        {<span class="stringliteral">&quot;resolution&quot;</span>, required_argument, NULL, <span class="charliteral">&#39;r&#39;</span>},</div><div class="line">        {<span class="stringliteral">&quot;min&quot;</span>,        required_argument, NULL, <span class="charliteral">&#39;m&#39;</span>},</div><div class="line">        {<span class="stringliteral">&quot;max&quot;</span>,        required_argument, NULL, <span class="charliteral">&#39;x&#39;</span>},</div><div class="line">        {<span class="stringliteral">&quot;period&quot;</span>,     required_argument, NULL, <span class="charliteral">&#39;p&#39;</span>},</div><div class="line">        {<span class="stringliteral">&quot;timeouts&quot;</span>,   required_argument, NULL, <span class="charliteral">&#39;t&#39;</span>},</div><div class="line">        {<span class="stringliteral">&quot;help&quot;</span>,       no_argument,       NULL, <span class="charliteral">&#39;h&#39;</span>},</div><div class="line">        {NULL, 0, NULL, 0}</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *shortopts = <span class="stringliteral">&quot;+c:r:m:x:p:t:h&quot;</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* defaults */</span></div><div class="line">    <a name="a44"></a><a class="code" href="group__odp__timer.html#ga7064c7d4e9f014ffd322222178d208b3">odp_timer_capability</a>(<a name="a45"></a><a class="code" href="group__odp__timer.html#gga8fe485cf54a752259326c68e425b7e3eaa42848fde230f4e53b190897777b0cbd">ODP_CLOCK_CPU</a>, &amp;timer_capa);</div><div class="line"></div><div class="line">    args-&gt;cpu_count     = 1;</div><div class="line">    args-&gt;resolution_us = MAX(10000,</div><div class="line">                  timer_capa.<a name="a46"></a><a class="code" href="structodp__timer__capability__t.html#af0616eb9ff6667d142bb0e6febef7135">highest_res_ns</a> /</div><div class="line">                    <a class="code" href="group__odp__time.html#gacc306c00304a0d479e89c2cd16d39938">ODP_TIME_USEC_IN_NS</a>);</div><div class="line">    args-&gt;min_us        = 0;</div><div class="line">    args-&gt;max_us        = 10000000;</div><div class="line">    args-&gt;period_us     = 1000000;</div><div class="line">    args-&gt;tmo_count     = 30;</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1) {</div><div class="line">        opt = getopt_long(argc, argv, shortopts, longopts, &amp;long_index);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (opt == -1)</div><div class="line">            <span class="keywordflow">break</span>;  <span class="comment">/* No more options */</span></div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span> (opt) {</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:</div><div class="line">            args-&gt;cpu_count = atoi(optarg);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span>:</div><div class="line">            args-&gt;resolution_us = atoi(optarg);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;m&#39;</span>:</div><div class="line">            args-&gt;min_us = atoi(optarg);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;x&#39;</span>:</div><div class="line">            args-&gt;max_us = atoi(optarg);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div><div class="line">            args-&gt;period_us = atoi(optarg);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>:</div><div class="line">            args-&gt;tmo_count = atoi(optarg);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:</div><div class="line">            print_usage();</div><div class="line">            exit(EXIT_SUCCESS);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (args-&gt;period_us &lt; args-&gt;resolution_us)</div><div class="line">        printf(<span class="stringliteral">&quot;\n\tWarn: timeout is set less then resolution\n&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">    odph_helper_options_t helper_options;</div><div class="line">    odph_odpthread_t thread_tbl[MAX_WORKERS];</div><div class="line">    <span class="keywordtype">int</span> num_workers;</div><div class="line">    <a class="code" href="struct__odp__abi__queue__t.html">odp_queue_t</a> queue;</div><div class="line">    uint64_t tick, ns;</div><div class="line">    <a name="_a47"></a><a class="code" href="structodp__queue__param__t.html">odp_queue_param_t</a> param;</div><div class="line">    <a name="_a48"></a><a class="code" href="structodp__pool__param__t.html">odp_pool_param_t</a> params;</div><div class="line">    <a name="_a49"></a><a class="code" href="structodp__timer__pool__param__t.html">odp_timer_pool_param_t</a> tparams;</div><div class="line">    <a name="_a50"></a><a class="code" href="structodp__timer__pool__info__t.html">odp_timer_pool_info_t</a> tpinfo;</div><div class="line">    <a name="_a51"></a><a class="code" href="structodp__cpumask__t.html">odp_cpumask_t</a> cpumask;</div><div class="line">    <span class="keywordtype">char</span> cpumaskstr[<a name="a52"></a><a class="code" href="group__odp__cpumask.html#gad1ca7686341a94f62ca32b87c269cf17">ODP_CPUMASK_STR_SIZE</a>];</div><div class="line">    <a class="code" href="group__odp__initialization.html#ga8d362bd3c7c87ab5892ca63b15c375c0">odp_instance_t</a> instance;</div><div class="line">    <a name="_a53"></a><a class="code" href="structodp__init__t.html">odp_init_t</a> init_param;</div><div class="line">    odph_odpthread_params_t thr_params;</div><div class="line">    <a name="_a54"></a><a class="code" href="struct__odp__abi__shm__t.html">odp_shm_t</a> shm = <a name="a55"></a><a class="code" href="group__odp__shared__memory.html#ga6e4289975efc279bb9f31880613a9d60">ODP_SHM_INVALID</a>;</div><div class="line">    test_globals_t *gbls = NULL;</div><div class="line">    <span class="keywordtype">int</span> err = 0;</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;\nODP timer example starts\n&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* Let helper collect its own arguments (e.g. --odph_proc) */</span></div><div class="line">    argc = odph_parse_options(argc, argv);</div><div class="line">    <span class="keywordflow">if</span> (odph_options(&amp;helper_options)) {</div><div class="line">        ODPH_ERR(<span class="stringliteral">&quot;Error: reading ODP helper options failed.\n&quot;</span>);</div><div class="line">        exit(EXIT_FAILURE);</div><div class="line">    }</div><div class="line"></div><div class="line">    <a name="a56"></a><a class="code" href="group__odp__initialization.html#ga145c4fc4417c8f58efd0852b34e25ba9">odp_init_param_init</a>(&amp;init_param);</div><div class="line">    init_param.<a name="a57"></a><a class="code" href="structodp__init__t.html#a7d368c740146170ebeb1651ce049919e">mem_model</a> = helper_options.mem_model;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a name="a58"></a><a class="code" href="group__odp__initialization.html#ga68d81088e65ef66180fb51076905e34d">odp_init_global</a>(&amp;instance, &amp;init_param, NULL)) {</div><div class="line">        err = 1;</div><div class="line">        printf(<span class="stringliteral">&quot;ODP global init failed.\n&quot;</span>);</div><div class="line">        <span class="keywordflow">goto</span> err_global;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Init this thread. */</span></div><div class="line">    <span class="keywordflow">if</span> (<a name="a59"></a><a class="code" href="group__odp__initialization.html#ga265470ea614bfeca9d8901e81ddefca9">odp_init_local</a>(instance, <a name="a60"></a><a class="code" href="group__odp__thread.html#ggafc7a7c180de9811d71b7cb050713bf53a9aab3fdb10eb2000a864bff81f23c00a">ODP_THREAD_CONTROL</a>)) {</div><div class="line">        err = 1;</div><div class="line">        printf(<span class="stringliteral">&quot;ODP local init failed.\n&quot;</span>);</div><div class="line">        <span class="keywordflow">goto</span> err_local;</div><div class="line">    }</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line">    <a name="a61"></a><a class="code" href="group__odp__system.html#gab0a1cd5e503d5ec067e8d17d228b937d">odp_sys_info_print</a>();</div><div class="line"></div><div class="line">    <span class="comment">/* Reserve memory for test_globals_t from shared mem */</span></div><div class="line">    shm = <a name="a62"></a><a class="code" href="group__odp__shared__memory.html#gacc441b0e100ec1c54e21f1745939a2d8">odp_shm_reserve</a>(<span class="stringliteral">&quot;shm_test_globals&quot;</span>, <span class="keyword">sizeof</span>(test_globals_t),</div><div class="line">                  ODP_CACHE_LINE_SIZE, 0);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__odp__shared__memory.html#ga6e4289975efc279bb9f31880613a9d60">ODP_SHM_INVALID</a> == shm) {</div><div class="line">        err = 1;</div><div class="line">        ODPH_ERR(<span class="stringliteral">&quot;Error: shared mem reserve failed.\n&quot;</span>);</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    gbls = <a name="a63"></a><a class="code" href="group__odp__shared__memory.html#gac94c4232f7cd64039bbaef601ff2c05e">odp_shm_addr</a>(shm);</div><div class="line">    <span class="keywordflow">if</span> (NULL == gbls) {</div><div class="line">        err = 1;</div><div class="line">        ODPH_ERR(<span class="stringliteral">&quot;Error: shared mem alloc failed.\n&quot;</span>);</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line">    memset(gbls, 0, <span class="keyword">sizeof</span>(test_globals_t));</div><div class="line">    gbls-&gt;pool = <a class="code" href="group__odp__pool.html#gafca03b58412260da754042a92f8a5e04">ODP_POOL_INVALID</a>;</div><div class="line">    gbls-&gt;tp = <a name="a64"></a><a class="code" href="group__odp__timer.html#ga4ad1abeaffbe94d9bbc66a0d8bab76c3">ODP_TIMER_POOL_INVALID</a>;</div><div class="line"></div><div class="line">    parse_args(argc, argv, &amp;gbls-&gt;args);</div><div class="line"></div><div class="line">    memset(thread_tbl, 0, <span class="keyword">sizeof</span>(thread_tbl));</div><div class="line"></div><div class="line">    num_workers = MAX_WORKERS;</div><div class="line">    <span class="keywordflow">if</span> (gbls-&gt;args.cpu_count &amp;&amp; gbls-&gt;args.cpu_count &lt; MAX_WORKERS)</div><div class="line">        num_workers = gbls-&gt;args.cpu_count;</div><div class="line"></div><div class="line">    <span class="comment">/* Get default worker cpumask */</span></div><div class="line">    num_workers = <a name="a65"></a><a class="code" href="group__odp__cpumask.html#ga4ff2d29f52775b12c7df1995754b524d">odp_cpumask_default_worker</a>(&amp;cpumask, num_workers);</div><div class="line">    (void)<a name="a66"></a><a class="code" href="group__odp__cpumask.html#gaac673804169b678e278704de7306a79f">odp_cpumask_to_str</a>(&amp;cpumask, cpumaskstr, <span class="keyword">sizeof</span>(cpumaskstr));</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;num worker threads: %i\n&quot;</span>, num_workers);</div><div class="line">    printf(<span class="stringliteral">&quot;first CPU:          %i\n&quot;</span>, <a name="a67"></a><a class="code" href="group__odp__cpumask.html#ga5c9dfaf2a18b336a537f552e122ac41d">odp_cpumask_first</a>(&amp;cpumask));</div><div class="line">    printf(<span class="stringliteral">&quot;cpu mask:           %s\n&quot;</span>, cpumaskstr);</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;resolution:         %i usec\n&quot;</span>, gbls-&gt;args.resolution_us);</div><div class="line">    printf(<span class="stringliteral">&quot;min timeout:        %i usec\n&quot;</span>, gbls-&gt;args.min_us);</div><div class="line">    printf(<span class="stringliteral">&quot;max timeout:        %i usec\n&quot;</span>, gbls-&gt;args.max_us);</div><div class="line">    printf(<span class="stringliteral">&quot;period:             %i usec\n&quot;</span>, gbls-&gt;args.period_us);</div><div class="line">    printf(<span class="stringliteral">&quot;timeouts:           %i\n&quot;</span>, gbls-&gt;args.tmo_count);</div><div class="line"></div><div class="line">    <span class="comment">/* Configure scheduler */</span></div><div class="line">    <a name="a68"></a><a class="code" href="group__odp__scheduler.html#gaa1b51ebd46adeb6aa7805fccb00144df">odp_schedule_config</a>(NULL);</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Create pool for timeouts</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <a name="a69"></a><a class="code" href="group__odp__pool.html#ga3dd8bcfb920f81142e9fe27cfba24073">odp_pool_param_init</a>(&amp;params);</div><div class="line">    params.<a name="a70"></a><a class="code" href="structodp__pool__param__t.html#a1a93c3bd99668b3c84771349365dbaae">tmo</a>.<a name="a71"></a><a class="code" href="structodp__pool__param__t.html#a3598b3a2496629cd45010c1c5e876250">num</a>   = NUM_TMOS;</div><div class="line">    params.<a name="a72"></a><a class="code" href="structodp__pool__param__t.html#af32325164d425ca91d6849b82467b783">type</a>      = <a name="a73"></a><a class="code" href="group__odp__pool.html#ga9acbd8701af44c986c00e891883a7759">ODP_POOL_TIMEOUT</a>;</div><div class="line"></div><div class="line">    gbls-&gt;pool = <a name="a74"></a><a class="code" href="group__odp__pool.html#ga256909a276600c25ce11b52ae274632f">odp_pool_create</a>(<span class="stringliteral">&quot;msg_pool&quot;</span>, &amp;params);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (gbls-&gt;pool == <a class="code" href="group__odp__pool.html#gafca03b58412260da754042a92f8a5e04">ODP_POOL_INVALID</a>) {</div><div class="line">        err = 1;</div><div class="line">        ODPH_ERR(<span class="stringliteral">&quot;Pool create failed.\n&quot;</span>);</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    tparams.<a name="a75"></a><a class="code" href="structodp__timer__pool__param__t.html#a0c9d28e284d142c3fe6ee5f8cc66171e">res_ns</a> = gbls-&gt;args.resolution_us * <a class="code" href="group__odp__time.html#gacc306c00304a0d479e89c2cd16d39938">ODP_TIME_USEC_IN_NS</a>;</div><div class="line">    tparams.<a name="a76"></a><a class="code" href="structodp__timer__pool__param__t.html#a8c358d197ea76dc7295025c23159e890">min_tmo</a> = gbls-&gt;args.min_us * <a class="code" href="group__odp__time.html#gacc306c00304a0d479e89c2cd16d39938">ODP_TIME_USEC_IN_NS</a>;</div><div class="line">    tparams.<a name="a77"></a><a class="code" href="structodp__timer__pool__param__t.html#af54f6e42c3f0fc4e2514c2d0df3023c2">max_tmo</a> = gbls-&gt;args.max_us * <a class="code" href="group__odp__time.html#gacc306c00304a0d479e89c2cd16d39938">ODP_TIME_USEC_IN_NS</a>;</div><div class="line">    tparams.<a name="a78"></a><a class="code" href="structodp__timer__pool__param__t.html#abe013f91043de4d7fa0003bce6701a3f">num_timers</a> = num_workers; <span class="comment">/* One timer per worker */</span></div><div class="line">    tparams.<a name="a79"></a><a class="code" href="structodp__timer__pool__param__t.html#a8b9276c132f7b79cf51787167febbfea">priv</a> = 0; <span class="comment">/* Shared */</span></div><div class="line">    tparams.<a name="a80"></a><a class="code" href="structodp__timer__pool__param__t.html#af491eee5937cbb0b8e18a85a9712c07c">clk_src</a> = <a class="code" href="group__odp__timer.html#gga8fe485cf54a752259326c68e425b7e3eaa42848fde230f4e53b190897777b0cbd">ODP_CLOCK_CPU</a>;</div><div class="line">    gbls-&gt;tp = <a name="a81"></a><a class="code" href="group__odp__timer.html#ga5119deda378994a468934aef41993965">odp_timer_pool_create</a>(<span class="stringliteral">&quot;timer_pool&quot;</span>, &amp;tparams);</div><div class="line">    <span class="keywordflow">if</span> (gbls-&gt;tp == <a class="code" href="group__odp__timer.html#ga4ad1abeaffbe94d9bbc66a0d8bab76c3">ODP_TIMER_POOL_INVALID</a>) {</div><div class="line">        err = 1;</div><div class="line">        ODPH_ERR(<span class="stringliteral">&quot;Timer pool create failed.\n&quot;</span>);</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line">    <a name="a82"></a><a class="code" href="group__odp__timer.html#ga1c28fd4fb9830d754aa00563448e82ec">odp_timer_pool_start</a>();</div><div class="line"></div><div class="line">    <a name="a83"></a><a class="code" href="group__odp__shared__memory.html#ga0257a416aacd98f9a25dd0685518c553">odp_shm_print_all</a>();</div><div class="line">    (void)<a name="a84"></a><a class="code" href="group__odp__timer.html#gacf39525bc4f8dd2d61ad4e963c931259">odp_timer_pool_info</a>(gbls-&gt;tp, &amp;tpinfo);</div><div class="line">    printf(<span class="stringliteral">&quot;Timer pool\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;----------\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;  name: %s\n&quot;</span>, tpinfo.<a name="a85"></a><a class="code" href="structodp__timer__pool__info__t.html#ae12ce6d1db5ced5bb9bf20d836383028">name</a>);</div><div class="line">    printf(<span class="stringliteral">&quot;  resolution: %&quot;</span>PRIu64<span class="stringliteral">&quot; ns\n&quot;</span>, tpinfo.<a name="a86"></a><a class="code" href="structodp__timer__pool__info__t.html#ac09e4f912ae8074a5c89bb854d0cdb47">param</a>.<a class="code" href="structodp__timer__pool__param__t.html#a0c9d28e284d142c3fe6ee5f8cc66171e">res_ns</a>);</div><div class="line">    printf(<span class="stringliteral">&quot;  min tmo: %&quot;</span>PRIu64<span class="stringliteral">&quot; ticks\n&quot;</span>, tpinfo.<a class="code" href="structodp__timer__pool__info__t.html#ac09e4f912ae8074a5c89bb854d0cdb47">param</a>.<a class="code" href="structodp__timer__pool__param__t.html#a8c358d197ea76dc7295025c23159e890">min_tmo</a>);</div><div class="line">    printf(<span class="stringliteral">&quot;  max tmo: %&quot;</span>PRIu64<span class="stringliteral">&quot; ticks\n&quot;</span>, tpinfo.<a class="code" href="structodp__timer__pool__info__t.html#ac09e4f912ae8074a5c89bb854d0cdb47">param</a>.<a class="code" href="structodp__timer__pool__param__t.html#af54f6e42c3f0fc4e2514c2d0df3023c2">max_tmo</a>);</div><div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Create a queue for timer test</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <a name="a87"></a><a class="code" href="group__odp__queue.html#ga6fc2ea5eb86152210342f7377d1468e4">odp_queue_param_init</a>(&amp;param);</div><div class="line">    param.<a name="a88"></a><a class="code" href="structodp__queue__param__t.html#a6a7251138773a3110bdc0e8d5f5b3be9">type</a>        = <a name="a89"></a><a class="code" href="group__odp__queue.html#gga89a3439d3f3be48cac1767cba721eddaa4f49ad2143a9ba8a5914573d2794e962">ODP_QUEUE_TYPE_SCHED</a>;</div><div class="line">    param.<a name="a90"></a><a class="code" href="structodp__queue__param__t.html#a371701df4d20cee95978b9265c232e32">sched</a>.<a name="a91"></a><a class="code" href="structodp__schedule__param__t.html#a3f103771c3a9319c1ec998fa8724b8ac">prio</a>  = <a name="a92"></a><a class="code" href="group__odp__scheduler.html#ga7bd0560d25e62ad6ee1dd01e37d7a087">ODP_SCHED_PRIO_DEFAULT</a>;</div><div class="line">    param.<a class="code" href="structodp__queue__param__t.html#a371701df4d20cee95978b9265c232e32">sched</a>.<a name="a93"></a><a class="code" href="structodp__schedule__param__t.html#ad4ca09d63edb0cec36567c26688cea14">sync</a>  = <a name="a94"></a><a class="code" href="group__odp__scheduler.html#ga2ba135fc660e1c050aa25ec6744ec584">ODP_SCHED_SYNC_PARALLEL</a>;</div><div class="line">    param.<a class="code" href="structodp__queue__param__t.html#a371701df4d20cee95978b9265c232e32">sched</a>.<a name="a95"></a><a class="code" href="structodp__schedule__param__t.html#a0bc7830a919f31ce295a20c51a7e2648">group</a> = <a name="a96"></a><a class="code" href="group__odp__scheduler.html#gaf463b15ad978dac0bf77c0110232b504">ODP_SCHED_GROUP_ALL</a>;</div><div class="line"></div><div class="line">    queue = <a name="a97"></a><a class="code" href="group__odp__queue.html#gab985be8c3947fef3da257e16948bf0f0">odp_queue_create</a>(<span class="stringliteral">&quot;timer_queue&quot;</span>, &amp;param);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (queue == <a name="a98"></a><a class="code" href="group__odp__queue.html#ga771259a58e71e065e0d00d2fc431b014">ODP_QUEUE_INVALID</a>) {</div><div class="line">        err = 1;</div><div class="line">        ODPH_ERR(<span class="stringliteral">&quot;Timer queue create failed.\n&quot;</span>);</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;CPU freq %&quot;</span>PRIu64<span class="stringliteral">&quot; Hz\n&quot;</span>, <a name="a99"></a><a class="code" href="group__odp__cpu.html#gab8e7912ddb39878a6105bc0387196dd9">odp_cpu_hz_max</a>());</div><div class="line">    printf(<span class="stringliteral">&quot;Timer ticks vs nanoseconds:\n&quot;</span>);</div><div class="line">    ns = 0;</div><div class="line">    tick = <a class="code" href="group__odp__timer.html#ga7fb23a28aa1db3c919aa49c90b2316fb">odp_timer_ns_to_tick</a>(gbls-&gt;tp, ns);</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;  %12&quot;</span> PRIu64 <span class="stringliteral">&quot; ns      -&gt;  %12&quot;</span> PRIu64 <span class="stringliteral">&quot; ticks\n&quot;</span>, ns, tick);</div><div class="line">    printf(<span class="stringliteral">&quot;  %12&quot;</span> PRIu64 <span class="stringliteral">&quot; ticks   -&gt;  %12&quot;</span> PRIu64 <span class="stringliteral">&quot; ns\n&quot;</span>, tick,</div><div class="line">           <a name="a100"></a><a class="code" href="group__odp__timer.html#ga0d06e6c0203ee0892f4e2d823682aa59">odp_timer_tick_to_ns</a>(gbls-&gt;tp, tick));</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (ns = 1; ns &lt;= 100 * <a name="a101"></a><a class="code" href="group__odp__time.html#ga49ab6f8fe6c0aa5b820717fd91f16ab5">ODP_TIME_SEC_IN_NS</a>; ns *= 10) {</div><div class="line">        tick = <a class="code" href="group__odp__timer.html#ga7fb23a28aa1db3c919aa49c90b2316fb">odp_timer_ns_to_tick</a>(gbls-&gt;tp, ns);</div><div class="line"></div><div class="line">        printf(<span class="stringliteral">&quot;  %12&quot;</span> PRIu64 <span class="stringliteral">&quot; ns      -&gt;  %12&quot;</span> PRIu64 <span class="stringliteral">&quot; ticks\n&quot;</span>, ns,</div><div class="line">               tick);</div><div class="line">        printf(<span class="stringliteral">&quot;  %12&quot;</span> PRIu64 <span class="stringliteral">&quot; ticks   -&gt;  %12&quot;</span> PRIu64 <span class="stringliteral">&quot; ns\n&quot;</span>, tick,</div><div class="line">               <a class="code" href="group__odp__timer.html#ga0d06e6c0203ee0892f4e2d823682aa59">odp_timer_tick_to_ns</a>(gbls-&gt;tp, tick));</div><div class="line">    }</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line"></div><div class="line">    gbls-&gt;num_workers = num_workers;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize number of timeouts to receive */</span></div><div class="line">    <a name="a102"></a><a class="code" href="group__odp__atomic.html#ga0029015adacaadb06ee94ea67d00eece">odp_atomic_init_u32</a>(&amp;gbls-&gt;remain, gbls-&gt;args.tmo_count * num_workers);</div><div class="line"></div><div class="line">    <span class="comment">/* Barrier to sync test case execution */</span></div><div class="line">    <a name="a103"></a><a class="code" href="group__odp__barrier.html#ga1416b47755c2af6267074959ac0d4840">odp_barrier_init</a>(&amp;gbls-&gt;test_barrier, num_workers);</div><div class="line"></div><div class="line">    <span class="comment">/* Create and launch worker threads */</span></div><div class="line">    memset(&amp;thr_params, 0, <span class="keyword">sizeof</span>(thr_params));</div><div class="line">    thr_params.start    = run_thread;</div><div class="line">    thr_params.arg      = gbls;</div><div class="line">    thr_params.thr_type = <a name="a104"></a><a class="code" href="group__odp__thread.html#ggafc7a7c180de9811d71b7cb050713bf53a2182066d714db5f2a4e994ad92f25b2a">ODP_THREAD_WORKER</a>;</div><div class="line">    thr_params.instance = instance;</div><div class="line"></div><div class="line">    odph_odpthreads_create(thread_tbl, &amp;cpumask, &amp;thr_params);</div><div class="line"></div><div class="line">    <span class="comment">/* Wait for worker threads to exit */</span></div><div class="line">    odph_odpthreads_join(thread_tbl);</div><div class="line"></div><div class="line">    <span class="comment">/* free resources */</span></div><div class="line">    <span class="keywordflow">if</span> (<a name="a105"></a><a class="code" href="group__odp__queue.html#gad1e1d2709808385025dd5f005f7690c4">odp_queue_destroy</a>(queue))</div><div class="line">        err = 1;</div><div class="line"></div><div class="line">err:</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (gbls != NULL &amp;&amp; gbls-&gt;tp != <a class="code" href="group__odp__timer.html#ga4ad1abeaffbe94d9bbc66a0d8bab76c3">ODP_TIMER_POOL_INVALID</a>)</div><div class="line">        <a name="a106"></a><a class="code" href="group__odp__timer.html#gafb56c5aff06be798de32d878266febc0">odp_timer_pool_destroy</a>(gbls-&gt;tp);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (gbls != NULL &amp;&amp; gbls-&gt;pool != <a class="code" href="group__odp__pool.html#gafca03b58412260da754042a92f8a5e04">ODP_POOL_INVALID</a>)</div><div class="line">        <span class="keywordflow">if</span> (<a name="a107"></a><a class="code" href="group__odp__pool.html#ga6ad439aaef911d82b972c915850e6924">odp_pool_destroy</a>(gbls-&gt;pool))</div><div class="line">            err = 1;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (shm != <a class="code" href="group__odp__shared__memory.html#ga6e4289975efc279bb9f31880613a9d60">ODP_SHM_INVALID</a>)</div><div class="line">        <span class="keywordflow">if</span> (<a name="a108"></a><a class="code" href="group__odp__shared__memory.html#ga0b02991b512acc119206b44c95a86ed6">odp_shm_free</a>(shm))</div><div class="line">            err = 1;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a name="a109"></a><a class="code" href="group__odp__initialization.html#ga6d15f0e1718da9477948dedb06a2f01a">odp_term_local</a>())</div><div class="line">        err = 1;</div><div class="line">err_local:</div><div class="line">    <span class="keywordflow">if</span> (<a name="a110"></a><a class="code" href="group__odp__initialization.html#ga87e9c66ad92201c9e0a710294eab1569">odp_term_global</a>(instance))</div><div class="line">        err = 1;</div><div class="line">err_global:</div><div class="line">    <span class="keywordflow">if</span> (err) {</div><div class="line">        printf(<span class="stringliteral">&quot;Err: ODP timer test failed\n\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;ODP timer test complete\n\n&quot;</span>);</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
